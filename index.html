<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<style>

    body {
        background: #e5e5e5;
    }

    #canvasOutput {
        margin: 100px auto;
        display: block;
    }

    #videoInput {
        display: none;
    }

    .title {
        margin: 20px;
        text-align: center;
    }

</style>
<body>
<div class="title">基于opencv.js（webassembly）前端人脸跟踪</div>
<video id="videoInput" width="320" height="240"></video>
<canvas id="canvasOutput"></canvas>
</body>
<script type="text/javascript">
  let opencvReadyPromiseResolve;
  window.opencvReadyPromise = new Promise(resolve => opencvReadyPromiseResolve = resolve);

  function onOpenCvReady() {
    opencvReadyPromiseResolve();
  }
</script>
<script src="./lib/utils.js" type="text/javascript"></script>
<script>
  const utils = new Utils('errorMessage');

  const startCameraAndSetDisplaySize = async () => {
    try {
      const video = document.getElementById('videoInput');
      const streaming = await navigator.mediaDevices.getUserMedia({video: true, audio: false});

      const {width, height} = streaming.getVideoTracks()[0].getSettings();

      const displayWidth = 400;
      const displayHeight = displayWidth / width * height;
      video.setAttribute('width', displayWidth);
      video.setAttribute('height', displayHeight);

      video.srcObject = streaming;
      video.play();
      return {
        video,
        streaming,
      };
    } catch (err) {
      console.log('摄像头开启错误', err);
      throw err;
    }
  }

  const getClassifier = async () => {
    const classifier = new cv.CascadeClassifier();
    const faceCascadeFile = './haarcascade_frontalface_default.xml';

    return new Promise(resolve => {
      utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
        classifier.load(faceCascadeFile);
        resolve(classifier);
      });
    })
  }

  const clearCVObject = (cvObjects) => {
    cvObjects.forEach(item => item?.delete?.());
  };

  const drawFaceRect = (faces, dst) => {
    for (let i = 0; i < faces.size(); ++i) {
      const face = faces.get(i);
      const pointLeftTop = new cv.Point(face.x, face.y);
      const pointRightBottom = new cv.Point(face.x + face.width, face.y + face.height);
      cv.rectangle(dst, pointLeftTop, pointRightBottom, [255, 80, 0, 255], 2);

      // const pointFont = new cv.Point(face.x, face.y - 10);
      // cv.putText(dst, 'cv: handsome', pointFont, cv.FONT_HERSHEY_SIMPLEX, .8, [255, 120, 0, 255], 2, cv.LINE_AA);
    }
  };

  let tipRectCount = 0;

  const drawTitleOnCanvas = (faces) => {
    tipRectCount += 1;
    const context = document.getElementById('canvasOutput').getContext('2d');
    for (let i = 0; i < faces.size(); ++i) {
      const face = faces.get(i);
      context.font = 'bold 20px sans-serif';
      context.fillStyle = 'rgb(255,80,0)';
      if (tipRectCount % 3 === 0) {
        context.rect(face.x, face.y - 24, 4, 14);
        context.fill();
      }
      context.fillText('handsome', face.x + 8, face.y - 10);
    }
  };

  const run = async () => {
    try {
      const {video, streaming} = await startCameraAndSetDisplaySize();
      const {cv} = window;

      const src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
      const dst = new cv.Mat(video.height, video.width, cv.CV_8UC4);
      const gray = new cv.Mat();
      const cap = new cv.VideoCapture(video);
      const faces = new cv.RectVector();

      let classifier = await getClassifier();

      const processVideo = () => {
        if (!streaming) {
          clearCVObject([src, dst, gray, faces, classifier]);
          return;
        }
        const begin = Date.now();
        cap.read(src);
        src.copyTo(dst);
        cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
        // detect faces.
        classifier.detectMultiScale(gray, faces, 1.1, 3, 0);
        drawFaceRect(faces, dst);
        cv.imshow('canvasOutput', dst);
        drawTitleOnCanvas(faces);

        const FPS = 60;
        const delay = 1000 / FPS - (Date.now() - begin);
        setTimeout(processVideo, delay);
      }

      setTimeout(processVideo, 0);
    } catch (err) {
      console.log('An error occurred! ' + err);
    }
  };

  (async () => {
    await window.opencvReadyPromise;
    run();
  })();
</script>
<script src="./lib/opencv.js" onload="onOpenCvReady()" type="text/javascript"></script>
</html>
